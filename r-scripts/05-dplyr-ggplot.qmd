---
title: "Starting with with the dplyr, ggplot2 packages, and the pipe operator |>"
author: "Han Olff"
date: "2024-08-29"
format: html
editor: 
  markdown: 
    wrap: 72
editor_options:
    chunk_output_type: console
---

# Working with the dplyr and ggplot2 packages

Load the required libraries :

```{r}
#| label: restore-all-package-versions
renv::restore() # restore your libraries from the lock file
```

```{r message = FALSE, warning = FALSE}
# clear the R environment
rm(list = ls())

# load the required packages
library(tidyverse)  # this loads a group of related packages, including readr, dplyr and ggplot2
```

We will work with an online database of the Schiermonnikoog transect
study, that you will collect additional data for next week in the field.
In this example, we work with measurements of cockles (a bivalve
mollusc) on their width and length. From the database Epibenthos, we
will work with the table
[FactCockles](https://docs.google.com/spreadsheets/d/1E1vUWAHhse7fhjBf94Kiog3Rsj7IkMuFtP-BTQX2oI8/edit?gid=1538766002#gid=1538766002).
See the documentation of the different variables in the table
[MetVariables](https://docs.google.com/spreadsheets/d/1E1vUWAHhse7fhjBf94Kiog3Rsj7IkMuFtP-BTQX2oI8/edit?gid=1290622213#gid=1290622213)

### Read the datafile from the Google sheets database

To read the data in R, you first need to know the published csv link of
the FactCockles table. In the database, you can find this link in the
table MetTables. It is produced in Google Sheets throught the menu
File/Share/Publish to web and then selecting the table and output as
csv.

Read the FactCockleSize table with read_csv, which reads it as tibble
(formatted dataframe)

```{r}
#There is a big outlier, likely a data entry error, so we remove it
FactCockleSize <- readr::read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSpormjGiM4uWMTIZYm9Upt5j1Ige_Wu9CrhGGdvjXwxmHP2R6S7JDyEmiGTn3fXihl5s5yBn_sdo8h/pub?gid=1538766002&single=true&output=csv")%>%
  dplyr::filter(CockleObs_ID!=1531 ,CockleObs_ID!=469) %>%
  dplyr::mutate(year=factor(year)) #add a year column
print(FactCockleSize)

```

#Plot with ggplot the relation between cockle thickness (thickness_mm, as
#x) and length (length_mm), 

```{r}
ggplot2::ggplot(data = FactCockleSize,#which data to use
                mapping =aes(x=length_mm, y=thickness_mm)) +  #what is on the axes
  geom_point()  #how to plot 
#find the other outlier 
FactCockleSize|>dplyr::filter(thickness_mm>10 & length_mm<5)
#remove the 469 above
FactCockleSize <- FactCockleSize |> dplyr::filter(thickness_mm<500)
```
#plot the graph with regression line
```{r}
ggplot2::ggplot(data = FactCockleSize,# which data to use
                mapping =aes(x=length_mm, y=thickness_mm)) +  #what is on the axes
  geom_point()+ #how to plot 
  geom_smooth(method = "lm")#add a regression line

#color the points by year, but plot one regression line 
ggplot2::ggplot(data = FactCockleSize,#which data to use
                mapping =aes(x=length_mm, y=thickness_mm)) +  #what is on the axes
  geom_point(mapping = aes(color=year)) +  #how to plot 
  geom_smooth(method = "lm")#add a regression line
```

Make same plot but showing a separate regression line per year

```{r}
# make a plot with each year as a separate graph
FactCockleSize|> # which data to use
dplyr::filter(year %in% c (2014,2015,2017,2018,2020,2021)) |>#add a year column
 ggplot2::ggplot(mapping =aes(x=length_mm, y=thickness_mm)) +  #what is on the axes
  geom_point(mapping = aes(color=year)) +  #how to plot 
  geom_smooth(method = "lm") + #add a regression line
facet_wrap(~year) #make a panel plot

```

Make a panel plot where with each year is shown as a separate graph

```{r}

```

We conclude from this that: \* there were two important outliers in the
dataset that were removed after visual inspection \* the regression
between length and width is abou the same for every year, we safely can
use only length as a proxy for the biomass of an individual cockle
